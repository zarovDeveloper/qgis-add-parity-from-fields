# QGIS Add Parity From All Fields

Универсальный PyQGIS скрипт для обработки векторных слоев .gpkg. Автоматически находит все целочисленные поля и создает для каждого соответствующее поле четности.

## Описание

Скрипт выполняет следующие операции:
- Загружает указанный векторный слой .gpkg
- Автоматически находит все поля с целочисленными типами данных
- Для каждого целочисленного поля создает новое поле `parity-{field_name}`
- Заполняет поля четности значениями:
  - `"even"` - для четных значений
  - `"odd"` - для нечетных значений
  - `NULL` - для некорректных значений

## Требования

- QGIS 3.x установленный на системе
- Python 3.9+ (с поддержкой современных типов аннотации)
- Poetry для управления зависимостями
- ruff для форматирования и линтинга кода

## Установка проекта

1. **Клонируйте репозиторий:**
   ```bash
   git clone <repository-url>
   cd qgis-add-parity-from-fields
   ```

2. **Установите зависимости через Poetry:**
   ```bash
   make install
   ```

3. **Убедитесь, что QGIS установлен на системе**

## Использование Make команд

Проект включает удобный Makefile для автоматизации задач разработки:

### Основные команды

- **`make help`** - показать все доступные команды
- **`make format`** - форматирование кода с помощью ruff
- **`make lint`** - проверка кода на ошибки
- **`make check`** - полная проверка (lint + format check)
- **`make fix`** - автоматическое исправление проблем
- **`make clean`** - очистка временных файлов

### Запуск скрипта

- **`make run`** - запуск скрипта с примером данных (data/city.gpkg)
- **`make run-help`** - показать справку по использованию скрипта

### Примеры использования

```bash
# Установка зависимостей
make install

# Форматирование и проверка кода
make format
make lint

# Запуск с примером данных
make run

# Получение справки по скрипту
make run-help

# Полная проверка перед коммитом
make check
```

## Прямой запуск скрипта

Если вы хотите запустить скрипт напрямую с собственными данными:

```bash
# Через QGIS Python (рекомендуется)
/Applications/QGIS-LTR.app/Contents/MacOS/bin/python3 src/add_parity_from_all_fields.py your_data.gpkg

# Или через системный Python (если настроены пути к QGIS)
python3 src/add_parity_from_all_fields.py your_data.gpkg

# Справка по параметрам
python3 src/add_parity_from_all_fields.py --help
```

## Структура проекта

```
qgis-add-parity-from-fields/
├── data/                           # Тестовые данные
│   ├── city.gpkg                   # Основной тестовый слой
│   ├── lakes.gpkg
│   ├── rastr.tif
│   └── roads.gpkg
├── src/                            # Исходный код
│   └── add_parity_from_all_fields.py  # Универсальный скрипт с типами
├── Makefile                        # Автоматизация задач разработки
├── pyproject.toml                  # Конфигурация Poetry
├── poetry.lock                     # Зафиксированные версии зависимостей
└── README.md                       # Документация
```

## Особенности кода

- **Модульная архитектура** - код разбит на специализированные функции
- **Типы аннотации** - современные типы для всех функций
- **Автоматическое форматирование** - ruff для поддержания стиля кода
- **Подробное логирование** - информация о каждом этапе обработки

## Результат работы

После успешного выполнения скрипта:
- В указанном слое будут созданы новые поля `parity-{field_name}` для каждого целочисленного поля
- Поля будут заполнены значениями на основе четности соответствующих полей
- В консоли будет выведена информация о процессе обработки

### Пример результата

Для слоя с полями `fid` и `SCALERANK` будут созданы:
- `parity-fid` - четность значений поля fid
- `parity-SCALERANK` - четность значений поля SCALERANK

## Возможные ошибки

- **"Файл не найден"** - убедитесь, что указанный файл .gpkg существует
- **"В слое не найдено целочисленных полей"** - слой не содержит полей для обработки
- **"ModuleNotFoundError: No module named 'qgis'"** - убедитесь, что используете Python из QGIS
- **"TypeError: unsupported operand type(s) for |"** - используйте Python 3.9+ или установите typing_extensions
- **"usage: add_parity_from_all_fields.py [-h] layer_path"** - не указан путь к файлу

## Разработка

Для разработки рекомендуется использовать Make команды:

```bash
# Перед началом работы
make install

# Во время разработки
make format  # форматирование
make lint    # проверка ошибок
make run     # тестирование

# Перед коммитом
make check   # полная проверка
```